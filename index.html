<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شارت حي + تسجيل ملامسات/اقترابات EMA 20/25/70 — US30 (بديل ^DJI)</title>

<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --text:#eaeaea; --muted:#a8a8a8;
    --accent:#0d84f2; --ok:#36c275; --warn:#ffb020; --bad:#ff5a6a;
    --ema20:#ffd21e; --ema25:#ff9a1e; --ema70:#4b83ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{background:#000;padding:12px 10px}
  .wrap{max-width:1100px;margin:0 auto;padding:0 10px}
  h1{font-weight:700;font-size:18px;margin:0 0 8px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  select,button,input{background:#232323;border:1px solid #333;color:var(--text);border-radius:10px;padding:10px 12px}
  button{cursor:pointer}
  button.primary{background:var(--accent);border-color:transparent}
  button.ghost{background:#1b1b1b}
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
  .card{background:var(--panel);border:1px solid #1f1f1f;border-radius:14px;padding:12px}
  #chart{height:520px}
  .legend{display:flex;gap:14px;margin-top:8px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .dot.y{background:var(--ema20)}
  .dot.o{background:var(--ema25)}
  .dot.b{background:var(--ema70)}
  .log{margin-top:14px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #2a2a2a;text-align:right;font-size:14px}
  th{color:#cfcfcf;font-weight:600}
  .empty{color:var(--muted);padding:14px;text-align:center}
  .badge{background:#1d1d1d;padding:6px 10px;border-radius:999px;border:1px solid #2b2b2b}
  .warn{color:var(--warn)}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>شارت مباشر + تسجيل ملامسات/اقترابات EMA 20/25/70 — <span class="badge">US30 (ThinkMarkets) بديل قراءة: ‎^DJI</span></h1>
      <div class="hint">لعرض الشموع وخطوط EMA نقرأ البيانات من Yahoo Finance للرمز ‎<b>^DJI</b>‎ (بديل قريب لـ US30).</div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="controls">
        <div class="row">
          <label>الفريم:</label>
          <select id="tf">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="30m">30m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1d</option>
          </select>

          <label>شرط اللمس (± نقاط):</label>
          <input id="touch" type="number" value="5" min="0" step="1" style="width:90px" />

          <button id="btnLoad" class="primary">تحديث الآن 🔄</button>
          <button id="btnAuto" class="ghost">بدء الرصد اللحظي ▶︎</button>
        </div>

        <div class="legend">
          <span><span class="dot y"></span> EMA 20 (أصفر)</span>
          <span><span class="dot o"></span> EMA 25 (برتقالي)</span>
          <span><span class="dot b"></span> EMA 70 (أزرق)</span>
        </div>
        <div id="note" class="hint"></div>
      </div>

      <div id="chart"></div>

      <div class="log">
        <h3 style="margin:14px 0 8px">السجل اللحظي — ملامسات/اقترابات EMA</h3>
        <div id="logEmpty" class="empty">لا توجد سجلات بعد. اضغط “تحديث الآن” أو فعّل “بدء الرصد اللحظي”.</div>
        <table id="logTable" style="display:none">
          <thead>
            <tr>
              <th>الحدث</th>
              <th>السعر</th>
              <th>الفريم</th>
              <th>الوقت (UTC)</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
        <div class="hint">يُضاف إلى السجل أيضًا إذا اقترب السعر من خط EMA ضمن ± فرق النقاط المحدّد—even بدون لمس كامل.</div>
      </div>
    </div>
  </main>

<script>
/* ===================== المساعدة ===================== */
const $ = sel => document.querySelector(sel);

function ema(series, length){
  const out = [];
  const k = 2 / (length + 1);
  let emaPrev = null;
  for (let i = 0; i < series.length; i++){
    const v = series[i];
    if (v == null) { out.push(null); continue; }
    if (emaPrev == null){
      // أول قيمة: متوسط بسيط أولي
      const start = Math.max(0, i - length + 1);
      const slice = series.slice(start, i + 1).filter(x => x != null);
      emaPrev = slice.length ? (slice.reduce((a,b)=>a+b,0)/slice.length) : v;
    } else {
      emaPrev = (v - emaPrev) * k + emaPrev;
    }
    out.push(emaPrev);
  }
  return out;
}

function tfToYahoo(tf){
  // تحويل الفريمات إلى interval/range لياهو
  // 30m و 4h تُقرّبان إلى 60m (1h)
  switch(tf){
    case '1m':  return { interval:'1m',  range:'1d',  label:'1m' };
    case '5m':  return { interval:'5m',  range:'5d',  label:'5m' };
    case '15m': return { interval:'15m', range:'5d',  label:'15m' };
    case '30m': return { interval:'60m', range:'5d',  label:'30m≈60m' };
    case '1h':  return { interval:'60m', range:'5d',  label:'1h' };
    case '4h':  return { interval:'60m', range:'1mo', label:'4h≈60m' };
    case '1d':  return { interval:'1d',  range:'1y',  label:'1d' };
    default:    return { interval:'15m', range:'5d',  label:'15m' };
  }
}

const SYMBOL = '%5EDJI'; // ^DJI مشفّر
let chart, candleSeries, ema20Series, ema25Series, ema70Series;
let pollTimer = null;

function setupChart(){
  if (chart) { chart.remove(); }
  chart = LightweightCharts.createChart(document.getElementById('chart'), {
    layout:{ background:{ color:'#0b0b0b'}, textColor:'#eaeaea' },
    grid:{ vertLines:{color:'#1d1d1d'}, horzLines:{color:'#1d1d1d'} },
    rightPriceScale:{borderColor:'#2a2a2a'},
    timeScale:{borderColor:'#2a2a2a'},
    crosshair:{ mode: LightweightCharts.CrosshairMode.Normal },
    localization:{ locale:'en-US' }
  });
  candleSeries = chart.addCandlestickSeries({
    upColor:'#0ecb81', downColor:'#ff4976', borderUpColor:'#0ecb81', borderDownColor:'#ff4976', wickUpColor:'#0ecb81', wickDownColor:'#ff4976'
  });
  ema20Series = chart.addLineSeries({ color:'#ffd21e', lineWidth:2 });
  ema25Series = chart.addLineSeries({ color:'#ff9a1e', lineWidth:2 });
  ema70Series = chart.addLineSeries({ color:'#4b83ff', lineWidth:3 });
}

async function fetchYahoo(tf){
  const {interval, range, label} = tfToYahoo(tf);
  // نحاول ياهو مباشرة — لديه CORS جيد عادة
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${SYMBOL}?interval=${interval}&range=${range}&includePrePost=false&events=div,splits`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Yahoo fetch failed');
  const json = await res.json();
  const r = json?.chart?.result?.[0];
  if (!r || !r.indicators?.quote?.[0]) throw new Error('Yahoo empty data');

  const ts = r.timestamp;
  const q = r.indicators.quote[0];
  const o = q.open, h = q.high, l = q.low, c = q.close;

  const candles = [];
  const closes  = [];
  for (let i=0;i<ts.length;i++){
    if (o[i]==null || h[i]==null || l[i]==null || c[i]==null) continue;
    candles.push({
      time: ts[i],
      open:  Number(o[i]),
      high:  Number(h[i]),
      low:   Number(l[i]),
      close: Number(c[i])
    });
    closes.push(Number(c[i]));
  }
  return { candles, closes, label };
}

function toLineData(candles, arr){
  const out = [];
  let j=0;
  for (let i=0;i<candles.length;i++){
    if (arr[i]==null) continue;
    out.push({ time: candles[i].time, value: Number(arr[i]) });
  }
  return out;
}

function appendLog({evt, price, tfLabel, time}){
  const body = $('#logBody');
  $('#logEmpty').style.display = 'none';
  $('#logTable').style.display = '';
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${evt}</td><td>${price.toFixed(2)}</td><td>${tfLabel}</td><td>${new Date(time*1000).toISOString().slice(0,19).replace('T',' ')}</td>`;
  body.prepend(tr);
}

function scanTouches({ candles, ema20Arr, ema25Arr, ema70Arr, tfLabel }){
  const tol = Number($('#touch').value || 0);
  if (!candles.length) return;
  // نفحص آخر شمعة (اللحظة) + أيضاً نمر على السلاسل كلها لالتقاط أي أحداث حديثة
  const lastN = Math.min(candles.length, 50);
  for (let i=candles.length-lastN;i<candles.length;i++){
    const bar = candles[i];
    const p = bar.close;
    const checks = [
      {name:'EMA 20', ema:ema20Arr[i]},
      {name:'EMA 25', ema:ema25Arr[i]},
      {name:'EMA 70', ema:ema70Arr[i]},
    ];
    checks.forEach(ch=>{
      if (ch.ema==null) return;
      const diff = Math.abs(p - ch.ema);
      if (diff <= tol){
        appendLog({ evt:`اقتراب/ملامسة ${ch.name}`, price:p, tfLabel, time:bar.time });
      }
    });
  }
}

async function loadAll(){
  try{
    $('#btnLoad').disabled = true;
    const tf = $('#tf').value;
    const data = await fetchYahoo(tf);
    setupChart();

    candleSeries.setData(data.candles);

    // EMAs
    const ema20Arr = ema(data.closes, 20);
    const ema25Arr = ema(data.closes, 25);
    const ema70Arr = ema(data.closes, 70);

    ema20Series.setData(toLineData(data.candles, ema20Arr));
    ema25Series.setData(toLineData(data.candles, ema25Arr));
    ema70Series.setData(toLineData(data.candles, ema70Arr));

    // ملاحظة الفريم
    const mapped = tfToYahoo(tf);
    $('#note').innerHTML = `المصدر: Yahoo Finance (الرمز ‎^DJI). الفريم المختار: <b>${tf}</b> &nbsp;→&nbsp; المرسل إلى Yahoo كـ <b>${mapped.interval}</b> / <b>${mapped.range}</b>${(mapped.label.includes('≈')?` <span class="warn">(مقرَّب: ${mapped.label})</span>`:'')}.`;

    scanTouches({ candles:data.candles, ema20Arr, ema25Arr, ema70Arr, tfLabel:mapped.label || tf });

  } catch(err){
    console.error(err);
    alert('تعذّر تحميل البيانات. جرّب فريم آخر أو أعد المحاولة بعد قليل.');
  } finally{
    $('#btnLoad').disabled = false;
  }
}

/* ============ أحداث الواجهة ============ */
$('#btnLoad').addEventListener('click', loadAll);
$('#tf').addEventListener('change', loadAll);

$('#btnAuto').addEventListener('click', ()=>{
  if (pollTimer){
    clearInterval(pollTimer);
    pollTimer = null;
    $('#btnAuto').textContent = 'بدء الرصد اللحظي ▶︎';
    $('#btnAuto').classList.remove('primary');
  } else {
    // تحديث كل 60 ثانية
    loadAll();
    pollTimer = setInterval(loadAll, 60*1000);
    $('#btnAuto').textContent = 'إيقاف الرصد ⏹';
    $('#btnAuto').classList.add('primary');
  }
});

// أول تحميل
setupChart();
loadAll();
</script>
</body>
</html>
