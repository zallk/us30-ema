<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>US30 / DJI â€” EMA Touch Logger</title>
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root { --bg:#0b0b0b; --panel:#141414; --txt:#fff; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:Arial,Helvetica,sans-serif}
    header{background:var(--panel);padding:12px 16px;font-weight:700;text-align:center}
    .wrap{max-width:1200px;margin:0 auto;padding:10px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0}
    select,button,input{background:#0b6bcb;border:0;color:#fff;padding:8px 12px;border-radius:6px;font-weight:700}
    select{appearance:none}
    button:hover{background:#0d84f2;cursor:pointer}
    #chart{height:78vh;width:100%} /* Ø´Ø§Ø±Øª ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ */
    .meta{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:6px;font-size:12px;opacity:.85}
    .log{background:var(--panel);border-radius:8px;margin-top:12px;padding:10px}
    .log h3{margin:0 0 8px 0;font-size:16px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #222;text-align:right}
    th{color:#bdbdbd}
    .badge{display:inline-block;padding:2px 8px;border-radius:12px;font-weight:700}
    .y{background:#FFD11A;color:#000} /* EMA20 */
    .o{background:#FF8C1A;color:#000} /* EMA25 */
    .b{background:#2E6BFF;color:#fff} /* EMA70 */
    .note{font-size:12px;opacity:.8}
    .tag{background:#222;padding:4px 8px;border-radius:6px}
    a, a:visited{color:#7bb7ff}
  </style>
</head>
<body>
  <header>ğŸ“Š US30 / DJI â€” ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ù…Ø³Ø© Ø§Ù„Ø³Ø¹Ø± Ù„Ø®Ø·ÙˆØ· EMA 20/25/70 Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª</header>

  <div class="wrap">
    <div class="topbar">
      <label>Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶:</label>
      <select id="tfSelect">
        <option value="15m">15m</option>
        <option value="30m">30m</option>
        <option value="60m" selected>1h</option>
        <option value="120m">2h</option>
        <option value="240m">4h</option>
        <option value="1d">1D</option>
      </select>

      <button id="refreshBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>

      <span class="tag">Ù‡Ø§Ù…Ø´ Ø§Ù„ØªÙ„Ø§Ù…Ø³: <span id="marginPct">0.10%</span></span>
      <span class="note">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: Yahoo Finance (Ø§Ù„Ø±Ù…Ø² ^DJI)</span>
    </div>

    <div id="chart"></div>

    <div class="meta">
      <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <strong id="lastUpdated">â€”</strong></span>
      <span>Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©</span>
    </div>

    <div class="log">
      <h3>Ø§Ù„Ø³Ø¬Ù„ â€” Ù…Ù„Ø§Ù…Ø³Ø© Ø§Ù„Ø³Ø¹Ø± Ù„Ø®Ø·ÙˆØ· EMA (ÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª)</h3>
      <table id="logTable">
        <thead>
          <tr>
            <th>Ø§Ù„Ø­Ø¯Ø«</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„ÙØ±ÙŠÙ…</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <!-- Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØªØ¶Ø§Ù Ù‡Ù†Ø§ -->
        </tbody>
      </table>
    </div>

    <p class="note">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„Ø±Ù…Ø² Ù†ÙØ³Ù‡ Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ù†ØµÙ‘Ø© ThinkMarkets:US30 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ^DJIØŒ Ù†Ù‚Ø¯Ø± Ù†ÙˆØµÙ„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ø¨Ø± TradingView Alerts/Webhook Ø£Ùˆ API Ù…Ø¯ÙÙˆØ¹.
    </p>
  </div>

  <script>
    // ========= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =========
    const VIEW_TFS = ['15m','30m','60m','120m','240m','1d']; // Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
    const TOUCH_MARGIN = 0.001; // 0.1% Ù‡Ø§Ù…Ø´ ÙÙˆÙ‚/ØªØ­Øª Ø§Ù„Ø´Ù…Ø¹Ø©
    document.getElementById('marginPct').textContent = (TOUCH_MARGIN*100).toFixed(2)+'%';

    // ========= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© =========
    const fmtTs = ts => {
      const d = new Date(ts*1000);
      const p = n => n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };
    const nowLocal = () => {
      const d = new Date(); const p = n=>n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    function ema(arr, len){
      const k = 2/(len+1);
      const out = []; let prev;
      for (let i=0;i<arr.length;i++){
        const v = arr[i]; if (v==null){ out.push(null); continue; }
        if (prev==null){
          const start = Math.max(0, i-len+1);
          const slice = arr.slice(start, i+1).filter(x=>x!=null);
          if (slice.length < len){ out.push(null); continue; }
          prev = slice.reduce((a,b)=>a+b,0)/slice.length;
        }
        const cur = v*k + prev*(1-k);
        out.push(cur); prev = cur;
      }
      return out;
    }

    function aggregate(candles, group){
      const out = [];
      for (let i=0;i<candles.length;i+=group){
        const ch = candles.slice(i,i+group);
        if (ch.length < group) continue;
        out.push({
          time: ch[ch.length-1].time,
          open: ch[0].open,
          close: ch[ch.length-1].close,
          high: Math.max(...ch.map(x=>x.high)),
          low:  Math.min(...ch.map(x=>x.low)),
        });
      }
      return out;
    }

    async function fetchYahoo(range, interval){
      const cacheBust = Math.floor(Date.now()/60000); // Ø¯Ù‚ÙŠÙ‚ÙŠØ© Ù„ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒØ§Ø´
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/%5EDJI?range=${range}&interval=${interval}&cb=${cacheBust}`;
      const r = await fetch(url);
      if (!r.ok) throw new Error('Yahoo fetch failed');
      const j = await r.json();
      const res = j.chart.result?.[0];
      const t = res.timestamp;
      const q = res.indicators.quote[0];
      const candles = [];
      for (let i=0;i<t.length;i++){
        if (q.open[i]==null||q.high[i]==null||q.low[i]==null||q.close[i]==null) continue;
        candles.push({ time:t[i], open:q.open[i], high:q.high[i], low:q.low[i], close:q.close[i] });
      }
      return candles;
    }

    // ========= Ø§Ù„Ø³Ø¬Ù„ =========
    const seen = new Set();
    function addLogRow(type, price, tf, ts){
      const key = `${type}-${tf}-${ts}`;
      if (seen.has(key)) return;
      seen.add(key);
      const tr = document.createElement('tr');
      const cls = type==='EMA20' ? 'y' : (type==='EMA25' ? 'o' : 'b');
      tr.innerHTML = `
        <td><span class="badge ${cls}">${type}</span> Ù„Ù…Ø³</td>
        <td>${Number(price).toFixed(2)}</td>
        <td>${tf}</td>
        <td>${fmtTs(ts)}</td>
      `;
      document.getElementById('logBody').prepend(tr);
    }

    // ========= ÙØ­Øµ Ø§Ù„Ù„Ù…Ø³ Ø¨Ù‡Ø§Ù…Ø´ =========
    function checkTouch(k, emaVal, type, tf){
      if (!emaVal) return;
      const margin = k.close * TOUCH_MARGIN;
      if ((k.low - margin) <= emaVal && emaVal <= (k.high + margin)){
        addLogRow(type, k.close, tf, k.time);
      }
    }

    // ========= Ù…Ø¹Ø§Ù„Ø¬Ø© ÙØ±ÙŠÙ… Ù…Ø¹ÙŠÙ‘Ù† =========
    async function processTF(tf){
      let candles;
      if (tf==='15m')      candles = await fetchYahoo('5d','15m');
      else if (tf==='30m') candles = await fetchYahoo('5d','30m');
      else if (tf==='60m') candles = await fetchYahoo('1mo','60m');
      else if (tf==='120m'){ const base = await fetchYahoo('1mo','30m'); candles = aggregate(base,4); }
      else if (tf==='240m'){ const base = await fetchYahoo('3mo','30m'); candles = aggregate(base,8); }
      else if (tf==='1d')  candles = await fetchYahoo('6mo','1d');
      else return null;

      const closes = candles.map(k=>k.close);
      const e20 = ema(closes,20), e25 = ema(closes,25), e70 = ema(closes,70);

      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³Ø§Øª
      for (let i=0;i<candles.length;i++){
        const k = candles[i];
        checkTouch(k, e20[i], 'EMA20', tf);
        checkTouch(k, e25[i], 'EMA25', tf);
        checkTouch(k, e70[i], 'EMA70', tf);
      }
      return {candles,e20,e25,e70};
    }

    // ========= Ø§Ù„Ø´Ø§Ø±Øª =========
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout: { background: { color: '#0b0b0b' }, textColor: '#FFFFFF' },
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false, rightOffset: 8, barSpacing: 8 },
      grid: { vertLines: { color: '#1a1a1a' }, horzLines: { color: '#1a1a1a' } }
    });
    const cs = chart.addCandlestickSeries();
    const s20 = chart.addLineSeries({ color:'#FFD11A', lineWidth:2 });
    const s25 = chart.addLineSeries({ color:'#FF8C1A', lineWidth:2 });
    const s70 = chart.addLineSeries({ color:'#2E6BFF', lineWidth:3 });

    async function renderChart(tf){
      const data = await processTF(tf);
      if (!data) return;
      const { candles, e20, e25, e70 } = data;

      cs.setData(candles.map(k=>({time:k.time,open:k.open,high:k.high,low:k.low,close:k.close})));
      s20.setData(candles.map((k,i)=> e20[i]?({time:k.time,value:e20[i]}):null).filter(Boolean));
      s25.setData(candles.map((k,i)=> e25[i]?({time:k.time,value:e25[i]}):null).filter(Boolean));
      s70.setData(candles.map((k,i)=> e70[i]?({time:k.time,value:e70[i]}):null).filter(Boolean));
    }

    // ========= Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ« =========
    const tfSelect = document.getElementById('tfSelect');
    document.getElementById('refreshBtn').onclick = runAll;
    tfSelect.onchange = () => renderChart(tfSelect.value);

    async function runAll(){
      // Ø³Ø¬Ù‘Ù„ Ù„ÙƒÙ„ Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª
      for (const tf of VIEW_TFS){ await processTF(tf); }
      // Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±
      await renderChart(tfSelect.value);
      document.getElementById('lastUpdated').textContent = nowLocal();
    }

    runAll();                         // Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
    setInterval(runAll, 86400000);    // ÙƒÙ„ 24 Ø³Ø§Ø¹Ø©
  </script>
</body>
</html>
