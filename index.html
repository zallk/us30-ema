<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>شارت مباشر + تسجيل ملامسات/اقترابات EMA 20/25/70 — US30 (بديل قراءة ^DJI)</title>
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#0b0b0b; --panel:#141414; --text:#eaeaea; --muted:#9aa0a6;
  --accent:#0d84f2; --ok:#28c36a; --warn:#ffb020; --bad:#ff5a6a;
  --ema20:#ffd21e; --ema25:#ff9a1e; --ema70:#4b83ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
header{background:#000;position:sticky;top:0;z-index:2;border-bottom:1px solid #111}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
h1{font-size:18px;margin:0 0 4px}
.badge{background:#1d1d1d;padding:4px 8px;border-radius:999px;border:1px solid #2b2b2b}
.hint{color:var(--muted);font-size:12px}
.card{background:var(--panel);border:1px solid #1f1f1f;border-radius:14px;padding:12px;margin-top:10px}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.controls .full{grid-column:1/-1}
label{font-size:13px;color:#cfcfcf;margin-bottom:4px;display:block}
select,button,input{width:100%;background:#222;border:1px solid #333;color:var(--text);border-radius:10px;padding:10px 12px}
button{cursor:pointer}
button.primary{background:var(--accent);border-color:transparent}
button.ghost{background:#1b1b1b}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.legend{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px}
.dot{display:inline-block;width:10px;height:10px;border-radius:50%}
.dot.y{background:var(--ema20)}
.dot.o{background:var(--ema25)}
.dot.b{background:var(--ema70)}
#chart{height:520px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #2a2a2a;text-align:right;font-size:14px}
th{color:#cfcfcf}
.empty{color:var(--muted);padding:14px;text-align:center}
.note{margin-top:6px;font-size:12px;color:#cfcfcf}
.warn{color:var(--warn)}
.center{display:flex;justify-content:center;align-items:center;min-height:60px}
@media(min-width:760px){
  .controls{grid-template-columns:repeat(4,1fr)}
}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>شارت مباشر + تسجيل ملامسات/اقترابات EMA 20/25/70 — <span class="badge">US30 (ThinkMarkets) قراءة من ‎^DJI</span></h1>
    <div class="hint">نستخدم بيانات Yahoo Finance للرمز ‎^DJI (بديل قريب لـ US30).</div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="controls">
      <div>
        <label>الفريم:</label>
        <select id="tf">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m" selected>15m</option>
          <option value="30m">30m (تقريب)</option>
          <option value="1h">1h</option>
          <option value="4h">4h (تقريب)</option>
          <option value="1d">1d</option>
        </select>
      </div>

      <div>
        <label>شرط اللمس (± نقاط):</label>
        <input id="touch" type="number" value="5" min="0" step="1">
      </div>

      <div>
        <label>تحديث يدوي:</label>
        <button id="btnLoad" class="primary">تحديث الآن 🔄</button>
      </div>

      <div>
        <label>رصد لحظي:</label>
        <button id="btnAuto" class="ghost">بدء الرصد اللحظي ▶︎</button>
      </div>

      <div class="full">
        <div class="legend">
          <span><span class="dot y"></span> EMA 20 (أصفر)</span>
          <span><span class="dot o"></span> EMA 25 (برتقالي)</span>
          <span><span class="dot b"></span> EMA 70 (أزرق)</span>
        </div>
        <div id="note" class="note"></div>
      </div>
    </div>

    <div id="chart" class="card" style="margin-top:12px"></div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">السجل اللحظي — ملامسات/اقترابات EMA</h3>
      <div id="logEmpty" class="empty">لا توجد سجلات بعد. اضغط “تحديث الآن” أو فعّل “بدء الرصد اللحظي”.</div>
      <table id="logTable" style="display:none">
        <thead>
          <tr>
            <th>الحدث</th>
            <th>السعر</th>
            <th>الفريم</th>
            <th>الوقت (UTC)</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
      <div class="hint">نعتبره حدثًا عند الملامسة أو الاقتراب ضمن ± فرق النقاط الذي تحدّده — حتى لو لم يلمس تمامًا.</div>
    </div>
  </div>
</main>

<script>
/* ====== أدوات عامة ====== */
const $ = s => document.querySelector(s);
const SYMBOL = '%5EDJI'; // ^DJI URL-encoded
let chart, candleSeries, ema20Series, ema25Series, ema70Series, pollTimer=null;

function savePrefs(){
  localStorage.setItem('tf',$('#tf').value);
  localStorage.setItem('touch',$('#touch').value);
}
function loadPrefs(){
  const tf = localStorage.getItem('tf'); if(tf) $('#tf').value=tf;
  const t  = localStorage.getItem('touch'); if(t) $('#touch').value=t;
}

/* ====== EMA ====== */
function ema(values, length){
  const out = [];
  const k = 2/(length+1);
  let prev=null;
  for(let i=0;i<values.length;i++){
    const v = values[i];
    if(v==null){ out.push(null); continue; }
    if(prev==null){
      const start = Math.max(0,i-length+1);
      const slice = values.slice(start,i+1).filter(x=>x!=null);
      prev = slice.length? slice.reduce((a,b)=>a+b,0)/slice.length : v;
    }else{
      prev = (v-prev)*k + prev;
    }
    out.push(prev);
  }
  return out;
}
function toLineData(candles, arr){
  const res=[]; for(let i=0;i<candles.length;i++){ if(arr[i]==null) continue; res.push({time:candles[i].time,value:+arr[i]}); }
  return res;
}

/* ====== تحويل الفريم لياهو ====== */
function tfToYahoo(tf){
  switch(tf){
    case '1m':  return {interval:'1m',  range:'1d',  label:'1m'};
    case '5m':  return {interval:'5m',  range:'5d',  label:'5m'};
    case '15m': return {interval:'15m', range:'5d',  label:'15m'};
    case '30m': return {interval:'60m', range:'5d',  label:'30m≈60m'};
    case '1h':  return {interval:'60m', range:'5d',  label:'1h'};
    case '4h':  return {interval:'60m', range:'1mo', label:'4h≈60m'};
    case '1d':  return {interval:'1d',  range:'1y',  label:'1d'};
    default:    return {interval:'15m', range:'5d',  label:'15m'};
  }
}

/* ====== جلب بيانات مع محاولات متعددة ====== */
async function fetchJsonWithFallbacks(urls){
  let lastErr;
  for(const u of urls){
    try{
      const res = await fetch(u, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const j = await res.json();
      return j;
    }catch(e){
      lastErr = e;
      // جرب التالي
    }
  }
  throw lastErr||new Error('fetch failed');
}
async function fetchYahoo(tf){
  const {interval,range,label} = tfToYahoo(tf);
  const base1 = `https://query1.finance.yahoo.com/v8/finance/chart/${SYMBOL}?interval=${interval}&range=${range}&includePrePost=false&events=div,splits`;
  const base2 = `https://query2.finance.yahoo.com/v8/finance/chart/${SYMBOL}?interval=${interval}&range=${range}&includePrePost=false&events=div,splits`;
  // بديل بسيط CORS proxy
  const proxy = `https://cors.isomorphic-git.org/${base1}`;
  const json = await fetchJsonWithFallbacks([base1, base2, proxy]);

  const r = json?.chart?.result?.[0];
  if(!r || !r.indicators?.quote?.[0]) throw new Error('No data from Yahoo');

  const ts = r.timestamp, q = r.indicators.quote[0];
  const o=q.open,h=q.high,l=q.low,c=q.close;
  const candles=[], closes=[];
  for(let i=0;i<ts.length;i++){
    if(o[i]==null || h[i]==null || l[i]==null || c[i]==null) continue;
    candles.push({time:ts[i], open:+o[i], high:+h[i], low:+l[i], close:+c[i]});
    closes.push(+c[i]);
  }
  if(!candles.length) throw new Error('Empty candles');

  return {candles, closes, label, mapping:{interval,range,label}};
}

/* ====== الرسم ====== */
function setupChart(){
  if(chart) chart.remove();
  chart = LightweightCharts.createChart($('#chart'),{
    layout:{background:{color:'#0b0b0b'}, textColor:'#eaeaea'},
    grid:{vertLines:{color:'#1d1d1d'}, horzLines:{color:'#1d1d1d'}},
    rightPriceScale:{borderColor:'#2a2a2a'},
    timeScale:{borderColor:'#2a2a2a'},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal}
  });
  candleSeries = chart.addCandlestickSeries({
    upColor:'#0ecb81', downColor:'#ff4976',
    borderUpColor:'#0ecb81', borderDownColor:'#ff4976',
    wickUpColor:'#0ecb81', wickDownColor:'#ff4976'
  });
  ema20Series = chart.addLineSeries({color:'var(--ema20)'.replace('var(--ema20)', '#ffd21e'), lineWidth:2});
  ema25Series = chart.addLineSeries({color:'var(--ema25)'.replace('var(--ema25)', '#ff9a1e'), lineWidth:2});
  ema70Series = chart.addLineSeries({color:'var(--ema70)'.replace('var(--ema70)', '#4b83ff'), lineWidth:3});
}

/* ====== السجل ====== */
function appendLog({evt, price, tfLabel, time}){
  const body = $('#logBody');
  $('#logEmpty').style.display='none';
  $('#logTable').style.display='';
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${evt}</td><td>${price.toFixed(2)}</td><td>${tfLabel}</td><td>${new Date(time*1000).toISOString().slice(0,19).replace('T',' ')}</td>`;
  body.prepend(tr);
}
function scanTouches({candles, ema20Arr, ema25Arr, ema70Arr, tfLabel}){
  const tol = +($('#touch').value||0);
  const lastN = Math.min(60, candles.length);
  for(let i=candles.length-lastN;i<candles.length;i++){
    const bar=candles[i], p=bar.close;
    const checks = [
      {name:'EMA 20', ema:ema20Arr[i]},
      {name:'EMA 25', ema:ema25Arr[i]},
      {name:'EMA 70', ema:ema70Arr[i]},
    ];
    for(const ch of checks){
      if(ch.ema==null) continue;
      if(Math.abs(p - ch.ema) <= tol){
        appendLog({evt:`اقتراب/ملامسة ${ch.name}`, price:p, tfLabel, time:bar.time});
      }
    }
  }
}

/* ====== التحميل الكامل ====== */
async function loadAll(){
  try{
    $('#btnLoad').disabled=true;
    const tf = $('#tf').value;
    const data = await fetchYahoo(tf);

    setupChart();
    candleSeries.setData(data.candles);
    const e20 = ema(data.closes,20);
    const e25 = ema(data.closes,25);
    const e70 = ema(data.closes,70);
    ema20Series.setData(toLineData(data.candles, e20));
    ema25Series.setData(toLineData(data.candles, e25));
    ema70Series.setData(toLineData(data.candles, e70));

    $('#note').innerHTML = `المصدر: Yahoo Finance (‎^DJI). الفريم المختار: <b>${$('#tf').value}</b> &nbsp;→&nbsp; أُرسل كـ <b>${data.mapping.interval}</b> / <b>${data.mapping.range}</b>${data.label.includes('≈')?` <span class="warn">(مقرّب: ${data.label})</span>`:''}.`;

    scanTouches({candles:data.candles, ema20Arr:e20, ema25Arr:e25, ema70Arr:e70, tfLabel:data.label});
    savePrefs();

  }catch(err){
    console.error(err);
    alert('تعذّر تحميل البيانات. جرّب فريم آخر (1m/5m/15m/1h/1d) أو أعد المحاولة بعد قليل.');
  }finally{
    $('#btnLoad').disabled=false;
  }
}

/* ====== أحداث الواجهة ====== */
$('#btnLoad').addEventListener('click', loadAll);
$('#tf').addEventListener('change', loadAll);
$('#btnAuto').addEventListener('click', ()=>{
  if(pollTimer){
    clearInterval(pollTimer); pollTimer=null;
    $('#btnAuto').textContent='بدء الرصد اللحظي ▶︎'; $('#btnAuto').classList.remove('primary');
  }else{
    loadAll();
    pollTimer=setInterval(loadAll, 60*1000);
    $('#btnAuto').textContent='إيقاف الرصد ⏹'; $('#btnAuto').classList.add('primary');
  }
});

/* بداية */
loadPrefs();
setupChart();
loadAll();
</script>
</body>
</html>
