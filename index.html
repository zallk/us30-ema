<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>US30 (ThinkMarkets) — شارت مباشر + تسجيل اقترابات/ملامسات EMA 20/25/70</title>
<meta name="theme-color" content="#0b0b0b" />
<link rel="manifest" href="manifest.webmanifest">
<style>
  :root{
    --bg:#0b0b0b; --panel:#141414; --txt:#eaeaea; --muted:#a4a4a4;
    --yel:#FFD23F; --org:#FF8C26; --blu:#3E78FF; --acc:#0d84f2; --red:#ff4d4d; --g:#1f1f1f;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{background:#000;padding:12px 14px;border-bottom:1px solid #111;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:18px}
  header small{color:var(--muted)}
  .wrap{max-width:1100px;margin:0 auto;padding:10px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  select,button,input[type=number]{
    background:#202020;color:#fff;border:1px solid #333;border-radius:8px;padding:10px 12px;font-size:14px
  }
  button{cursor:pointer}
  button.primary{background:var(--acc);border-color:#0575d1}
  button.ghost{background:#202020}
  .note{color:var(--muted);font-size:13px;margin-top:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .panel{background:var(--panel);border:1px solid #1c1c1c;border-radius:12px;overflow:hidden}
  .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid #1c1c1c;background:#0f0f0f;font-size:14px}
  #chart{height:70vh;min-height:440px}
  .legend{display:flex;gap:14px;align-items:center;padding:10px 12px;border-top:1px solid #1c1c1c;background:#0f0f0f}
  .dot{width:10px;height:10px;border-radius:50%}
  .yel{background:var(--yel)} .org{background:var(--org)} .blu{background:var(--blu)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid #222;font-size:14px}
  th{color:#bbb;background:#111;position:sticky;top:0}
  tbody tr:hover{background:#171717}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:20px;background:#1f1f1f;border:1px solid #282828;color:#ddd;font-size:12px}
  .muted{color:var(--muted)}
  .warn{color:var(--red)}
  .foot{color:#9b9b9b;font-size:12px;padding:8px 12px;border-top:1px solid #1c1c1c}
</style>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
<header>
  <h1>📈 خطوط EMA — US30 (ThinkMarkets) — <small>أصفر 20 / برتقالي 25 / أزرق 70</small></h1>
</header>

<div class="wrap grid">

  <div class="panel">
    <h3>الإعدادات</h3>
    <div class="controls">
      <label class="badge">الفريم:
        <select id="tf">
          <option value="15">15m</option>
          <option value="30">30m</option>
          <option value="60" selected>1h</option>
          <option value="120">2h</option>
          <option value="240">4h</option>
          <option value="D">1D</option>
        </select>
      </label>

      <label class="badge">شرط اللمس: ±
        <input id="pxTol" type="number" step="1" value="5" style="width:80px"> نقاط
      </label>

      <button id="btnRefresh" class="primary">تحديث الآن 🔄</button>
      <button id="btnWatch" class="ghost">بدء الرصد اللحظي ▶️</button>
      <span id="srcTag" class="badge">المصدر: بيانات مجانية (Stooq/Yahoo)</span>
    </div>

    <div id="chart"></div>

    <div class="legend">
      <span class="badge"><span class="dot yel"></span> EMA 20</span>
      <span class="badge"><span class="dot org"></span> EMA 25</span>
      <span class="badge"><span class="dot blu"></span> EMA 70</span>
      <span class="note" id="legendInfo"></span>
    </div>
    <div class="foot">يتم بناء 2h/4h محليًا من 1h. آخر تحديث: <span id="lastUpd">—</span></div>
  </div>

  <div class="panel">
    <h3>الملخص — تسجيل لحظي لاقترابات/ملامسات EMA</h3>
    <div class="note" style="padding:8px 12px">
      ✳️ يتم تسجيل أي إغلاق يبعد ≤ <b id="tolEcho">5</b> نقاط عن أي من خطوط EMA 20/25/70 (حتى لو لم يلمس).
    </div>
    <div style="max-height:40vh;overflow:auto">
      <table id="logTbl">
        <thead>
          <tr>
            <th>الحدث</th><th>السعر</th><th>EMA</th><th>الفريم</th><th>الوقت (UTC)</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr><td colspan="5" class="muted">— لا توجد سجلات بعد. اضغط "بدء الرصد اللحظي" أو "تحديث الآن".</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========= Helpers ========= */
const fmt = (n)=> Number(n).toLocaleString('en-US', {maximumFractionDigits:2});
const tfSel = document.getElementById('tf');
const tolInput = document.getElementById('pxTol');
const tolEcho = document.getElementById('tolEcho');
const lastUpd = document.getElementById('lastUpd');
const legendInfo = document.getElementById('legendInfo');
let watchTimer = null;

/* ========= Chart ========= */
const chart = LightweightCharts.createChart(document.getElementById('chart'), {
  layout: { background: { color: '#0b0b0b' }, textColor: '#dcdcdc' },
  grid: { vertLines:{color:'#1c1c1c'}, horzLines:{color:'#1c1c1c'} },
  rightPriceScale: { borderColor:'#2b2b2b' },
  timeScale: { borderColor:'#2b2b2b', timeVisible:true, secondsVisible:false },
  crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
});
const candleSeries = chart.addCandlestickSeries({ upColor:'#26a69a', downColor:'#ef5350', wickUpColor:'#26a69a', wickDownColor:'#ef5350', borderVisible:false });

const ema20 = chart.addLineSeries({ color:'#FFD23F', lineWidth:2 });
const ema25 = chart.addLineSeries({ color:'#FF8C26', lineWidth:2 });
const ema70 = chart.addLineSeries({ color:'#3E78FF', lineWidth:2 });

/* ========= Data fetching =========
   سنستخدم Stooq CSV للفريمات 15m/30m/60m واليومي.
   2h/4h يتم تكوينها من 60m محليًا. */
async function fetchStooqCSV(interval){ // interval: '15','30','60','D'
  let baseSym = '%5Edji'; // ^DJI (Dow Jones)
  let url;
  if(interval==='D'){
    // يومي
    url = `https://stooq.com/q/d/l/?s=${baseSym}&i=d`;
  }else{
    url = `https://stooq.com/q/d/l/?s=${baseSym}&i=${interval}`;
  }
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('Stooq fetch failed');
  const text = await res.text();
  const rows = text.trim().split('\n').slice(1).map(r=>r.split(','));
  return rows.map(([date,time,open,high,low,close,vol])=>{
    let ts;
    if(time){ // intraday
      ts = Date.parse(`${date}T${time}Z`)/1000;
    }else{ // daily
      ts = Date.parse(`${date}T00:00:00Z`)/1000;
    }
    return {
      time: ts,
      open: +open, high:+high, low:+low, close:+close, volume:+(vol||0)
    };
  });
}

// تجميع 60m إلى 120/240 دقيقة
function resample(candles, group){
  const out = [];
  for(let i=0;i<candles.length;i+=group){
    const chunk = candles.slice(i, i+group);
    if(chunk.length<group) continue;
    const open = chunk[0].open;
    const close = chunk[chunk.length-1].close;
    const high = Math.max(...chunk.map(c=>c.high));
    const low  = Math.min(...chunk.map(c=>c.low));
    const time = chunk[chunk.length-1].time;
    out.push({time, open, high, low, close});
  }
  return out;
}

// حساب EMA
function calcEMA(data, period){
  const k = 2/(period+1);
  let emaArr = [];
  let emaPrev = null;
  for(let i=0;i<data.length;i++){
    const c = data[i].close;
    if(i<period-1){ emaArr.push({time:data[i].time, value: NaN}); continue; }
    if(emaPrev===null){
      // أول EMA = متوسط بسيط لأول period
      const seed = data.slice(i-period+1,i+1).reduce((s,x)=>s+x.close,0)/period;
      emaPrev = seed;
      emaArr.push({time:data[i].time, value: seed});
    }else{
      const v = (c - emaPrev)*k + emaPrev;
      emaPrev = v;
      emaArr.push({time:data[i].time, value: v});
    }
  }
  return emaArr;
}

// تسجيل الاقترابات/الملامسات
const logBody = document.getElementById('logBody');
function appendLogRow({price, emaName, timeframe, time}){
  // إذا كانت أول سطر placeholder احذفه
  if(logBody.firstElementChild && logBody.firstElementChild.children.length===1){
    logBody.innerHTML='';
  }
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>اقتراب/لمس</td>
    <td>${fmt(price)}</td>
    <td>${emaName}</td>
    <td>${timeframe}</td>
    <td>${new Date(time*1000).toISOString().slice(0,16).replace('T',' ')}</td>
  `;
  logBody.prepend(tr);
}

// فحص آخر شمعة لأي اقتراب
function checkTouches(candles, ema20Arr, ema25Arr, ema70Arr, tf, tolPx){
  if(!candles.length) return;
  const last = candles[candles.length-1];
  const e20 = ema20Arr[ema20Arr.length-1]?.value;
  const e25 = ema25Arr[ema25Arr.length-1]?.value;
  const e70 = ema70Arr[ema70Arr.length-1]?.value;
  const check = (emaVal, name)=>{
    if(!isFinite(emaVal)) return;
    const diff = Math.abs(last.close - emaVal);
    if(diff <= tolPx){
      appendLogRow({price:last.close, emaName:name, timeframe:tfLabel(tf), time:last.time});
    }
  };
  check(e20,'EMA 20');
  check(e25,'EMA 25');
  check(e70,'EMA 70');
}

function tfLabel(code){
  if(code==='D') return '1D';
  if(code==='60') return '1h';
  if(code==='120') return '2h';
  if(code==='240') return '4h';
  if(code==='30') return '30m';
  if(code==='15') return '15m';
  return code;
}

/* ========= Main loader ========= */
async function loadAndRender(){
  const tf = tfSel.value;               // '15','30','60','120','240','D'
  const tolPx = Number(tolInput.value)||5;
  tolEcho.textContent = tolPx;
  legendInfo.textContent = `الفريم المعروض: ${tfLabel(tf)} — شرط اللمس: ±${tolPx} نقطة`;

  let candles;
  try{
    if(tf==='15' || tf==='30' || tf==='60'){
      candles = await fetchStooqCSV(tf);
    }else if(tf==='120' || tf==='240'){
      // إجلب 60m ثم أعد التجميع
      const base = await fetchStooqCSV('60');
      candles = resample(base, tf==='120'?2:4);
    }else if(tf==='D'){
      candles = await fetchStooqCSV('D');
    }
  }catch(e){
    console.error(e);
    alert('تعذر تحميل البيانات المجانية حالياً. جرّب لاحقاً.');
    return;
  }

  // رسم الشموع
  candleSeries.setData(candles);

  // حساب ورسم EMAs
  const e20 = calcEMA(candles, 20);
  const e25 = calcEMA(candles, 25);
  const e70 = calcEMA(candles, 70);
  ema20.setData(e20); ema25.setData(e25); ema70.setData(e70);

  // فحص الاقترابات
  checkTouches(candles, e20, e25, e70, tf, Number(tolInput.value)||5);

  lastUpd.textContent = new Date().toLocaleString('en-GB',{hour12:false});
}

/* ========= Events ========= */
document.getElementById('btnRefresh').onclick = loadAndRender;
tfSel.onchange = loadAndRender;
tolInput.onchange = ()=>{ tolEcho.textContent = Number(tolInput.value)||5; };

document.getElementById('btnWatch').onclick = (e)=>{
  if(watchTimer){ clearInterval(watchTimer); watchTimer=null; e.target.textContent='بدء الرصد اللحظي ▶️'; return; }
  e.target.textContent='إيقاف الرصد ⏸️';
  // فحص كل دقيقة
  loadAndRender();
  watchTimer = setInterval(loadAndRender, 60*1000);
};

// تحميل أولي
loadAndRender();
</script>
</body>
</html>
