...
<script>
    // ---------- إعدادات عامة ----------
    const SYMBOL_TITLE = '^DJI';              
    const VIEW_TFS = ['15m','30m','60m','120m','240m','1d']; 
    const ONE_DAY_MS = 24*60*60*1000;
    const TOUCH_MARGIN = 0.001; // 0.1% هامش إضافي

    // ---------- أدوات مساعدة ----------
    const fmt = ts => {
      const d = new Date(ts*1000);
      const p = n => n.toString().padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    function ema(arr, len){
      const k = 2/(len+1);
      const out = [];
      let prev;
      for (let i=0;i<arr.length;i++){
        const v = arr[i];
        if (v==null){ out.push(null); continue; }
        if (prev==null){
          const start = Math.max(0, i-len+1);
          const slice = arr.slice(start, i+1).filter(x=>x!=null);
          if (slice.length < len){ out.push(null); continue; }
          prev = slice.reduce((a,b)=>a+b,0)/slice.length;
        }
        const cur = v*k + prev*(1-k);
        out.push(cur);
        prev = cur;
      }
      return out;
    }

    // ---------- تسجيل اللمسات بفارق أعلى/أدنى مع هامش ----------
    const touchSeen = new Set();
    function checkTouch(k, emaVal, type, tf){
      if (!emaVal) return;
      const margin = k.close * TOUCH_MARGIN;
      const lowAdj = k.low - margin;
      const highAdj = k.high + margin;
      if (lowAdj <= emaVal && emaVal <= highAdj){
        const key = `${type}-${tf}-${k.time}`;
        if (touchSeen.has(key)) return;
        touchSeen.add(key);
        appendLog(type, k.close, tf, k.time);
      }
    }

    async function processTF(tf){
      let candles;
      if (tf==='15m'){ candles = await fetchYahoo('5d','15m'); }
      else if (tf==='30m'){ candles = await fetchYahoo('5d','30m'); }
      else if (tf==='60m'){ candles = await fetchYahoo('1mo','60m'); }
      else if (tf==='120m'){ const base = await fetchYahoo('1mo','30m'); candles = aggregate(base,4); }
      else if (tf==='240m'){ const base = await fetchYahoo('3mo','30m'); candles = aggregate(base,8); }
      else if (tf==='1d'){ candles = await fetchYahoo('6mo','1d'); }

      const closes = candles.map(k=>k.close);
      const e20 = ema(closes,20);
      const e25 = ema(closes,25);
      const e70 = ema(closes,70);

      for (let i=0;i<candles.length;i++){
        const k = candles[i];
        checkTouch(k, e20[i], 'EMA20', tf);
        checkTouch(k, e25[i], 'EMA25', tf);
        checkTouch(k, e70[i], 'EMA70', tf);
      }

      return { candles, e20, e25, e70 };
    }
...
</script>
